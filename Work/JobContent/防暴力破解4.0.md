# 防暴力破解调研文档

## 1. 背景

开放到公网的主机无时无刻不在遭受攻击，其中ssh暴力破解频率最高，会有无数机器不分日夜地搜索公网上的猎物，然后进行弱密码尝试。所以防止暴力破解 SSH（安全外壳协议）是一项重要的安全措施，以下是一些当前主流的检测 SSH 异常登录的技术及其原理。

>  弱密码是指容易被猜测、破解或安全性较低的密码。



## 2. 现状

现有的一般防御方法都有明显的缺点，比如：

1. **密码设得超强/使用密钥**——别人爆破我无所谓、但是只适用于用户层面，不应该把问题抛给客户

2. **更改端口号**——其实无效，攻击者会端口扫描

3. **禁止root用户远程登录**——仍要超级管理员登录可以添加一个和root一样权限的用户，而且更改root的用户名，系统软件会出问题

4. **使用ip白名单**——只适合在固定网络环境下使用



## 3. 技术方案

### 3.1 基于日志分析的入侵检测

#### 3.1.1 技术原理

- SSH 服务器通常会记录所有登录尝试的信息，包括成功和失败的登录尝试。这些日志文件（如 `/var/log/auth.log`）或 `/var/log/secure`）提供了用户登录活动的详细信息。
- 通过定期分析这些日志，可以识别出异常登录模式，比如来自同一 IP 的大量失败登录尝试，或者在非正常工作时间内的登录尝试。

#### 3.1.2 技术应用

市面上使用到该技术的防暴力破解工具有**DenyHosts、Fail2ban** ，这两款旨在通过监控和解析 SSH 登录日志来防止异常登录行为

1. DenyHosts：是专门为防止针对 SSH 服务的暴力破解攻击设计的工具，它通过持续监控 SSH 登录的日志文件来检测多次失败的登录尝试，并根据规则自动将可疑的 IP 地址加入禁止列表
2. Fail2ban：是一个更通用的安全工具，它不仅可以防止 SSH 暴力破解，还可以保护其他服务，如 FTP、HTTP 等。Fail2ban 同样通过监控日志文件来检测异常登录行为，并自动采取禁止 IP 地址的措施。

#### 3.1.3 设计方案

1. 日志监控：定时读取SSH 相关的安全日志文件（如 `/var/log/auth.log`）。匹配到含有`"Failed password"`字段的记录，获取登录失败的ip、时间、重复失败次数等信息
2. 规则匹配：定义触发封禁的规则，包括：连续登录失败次数的阈值、封禁动作、时间参数等
3. 封禁执行：规则满足时就与防火墙联动，将可疑ip添加到封禁列表中
4. 自动解封：根据配置的时间参数，封禁一段时间后如果没有再次检测到恶意行为，就自动解除对该ip的封禁

<img src="D:%5CDocument%5CDayDayNote%5C%E9%98%B2%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A34.0%5Cimages%5Cimage-20241010155213122.png" alt="image-20241010155213122" style="zoom:80%;" />

#### 3.1.4 优缺点

优点：

1. 简单易实现
2. 成本低
3. 实时反应：根据日志信息的变化及时阻止暴力破解攻击

缺点：

1. 只基于已知行为：只能检测到明显的已知的攻击模式
2. 滞后性：日志是时间发生后的记录，所以具体实现时检测间隔要设置秒级





### 3.2 基于流量分析的入侵检测

#### 3.2.1 技术原理

- 建立ssh连接请求需要发送目的端口号为22的tcp连接数据包（检测SYN字段为1的是连接包）
- 通过分析这些连接数据包在特定时间段内的流量、高频率访问等行为，可以筛选出可疑ip，进行后续封禁操作

#### 3.2.2 技术应用

市面上用到该技术的网络安全监控工具有**Suricata** 和 **Zeek**，这两款工具旨在监控网络流量和行为来防止异常登录

1. **Suricata** ：是一个高性能的**网络入侵检测和防御系统（NIDS/NIPS）**，主要基于预定义的规则和签名来检测网络中的异常行为。
   - **规则检测**：Suricata 通过签名规则来检测特定的攻击或异常行为。可以编写或使用现有的规则来检测与 SSH 暴力破解、端口扫描和异常登录相关的攻击
   - **流量模式识别**：Suricata 可以检测到与 SSH 登录相关的流量模式，可以检测到暴力破解攻击以及异常登录时间或频率

2. **Zeek** ：是一个灵活、强大的**网络安全监控框架**，其分析侧重点在于**网络流量中的协议行为和事件处理**，比 Suricata 更注重高级的网络行为分析。
   - **协议分析和事件处理**：Zeek 具有强大的协议解析能力，可以监控和分析 SSH 会话中的详细行为。它可以记录登录事件、登录成功与否、登录的 IP 地址、用户名等信息。
   - **自定义检测策略**：Zeek 的强大之处在于其脚本语言，用户可以根据实际需求编写脚本来检测异常 SSH 登录，如通过脚本监控短时间内的多次 SSH 登录尝试

#### 3.2.3 设计方案

1. 网络数据包获取：使用网络数据包捕获库，如`"libcap"`，设置过滤器，捕获特定端口(22)的数据包，获取数据的源ip、时间戳等信息
2. 异常检测：定义异常检测规则，如在短时间内来自同一个ip的大量数据包将其设定为异常ip
3. 响应操作：同3.1.3，实现封禁操作和解封策略。

<img src="C:\Users\贾元第\AppData\Roaming\Typora\typora-user-images\image-20240930104936417.png" alt="image-20240930104936417" style="zoom: 80%;" />

#### 3.2.4 优缺点

优点：

1. 实时性强
2. 无需依赖日志

缺点：

1. 资源消耗大：占用大量带宽和计算资源

2. 容易误报：正常的流量波动有时会被误认为异常
3. 很难通过分析网络数据包来设置阈值





## 4. 技术补充

### 4.1 基于流量特征的入侵检测

> 参考：[基于流量特征的登录账号密码暴力破解攻击检测方法 - 道客巴巴 (doc88.com)](https://www.doc88.com/p-3595619347741.html)

#### 4.1.1 技术背景

在常用的基于流量特征的攻击识别中，目前技术研究重点主要针对单个协议，但真实场景中针对多种协议的攻击是并存的。

#### 4.1.2 技术原理

1. 进程特征：应用进程是网络通信的终点，两台网络主机间可能存在不止一个通信进程，在`tcp/Ip`协议族中，运输层使用`ip`地址和协议端口号来区分主机的不同进程。通过对大量实验数据分析可知：
   - **正常的远程连接中两台主机间的通信进程数维持在一个左右**，少有波动；
   - 但暴力破解攻击中，攻击者为加快攻击速度，会同时开启多个进程进行攻击；

2. 数据包特征：所有在因特网上传送的数据都是以分组（即`ip`数据报）为传送单位的，计算机将数据封装成数据包时， 会在包头加入一些信息。通过分析大量的正常数据包和异常数据包包头发现：
   - 异常数据在包的平均大小和 进程发包数上有很强的统计规律（**同一种攻击软件每分钟发送的数据包大小、数量都是固定的**）
   - 而正常用户通信中不存在这种规律，可以通过统计数据包包头信息来分析是否存在统计特征作为判定暴力破解的依据．

3. 以min为单位抓取数据包，统计进程数、进程平均发包数，根据对应的分析算法进行进程特征的检测和数据包特征检测

#### 4.1.3 设计实现

1. 抓取数据包：使用抓包工具抓取流经网卡的数据包，以`min`为单位保存pcap文件`Ni`(i=1,2,3,...)

2. 解析数据包：解析Ni中的五元组(源ip地址、源端口、目的ip地址、目的端口和应用层协议)

3. 分组：保留 `Ni`中含有有用协议的数据包，将数据包分组、相同源ip到目的ip的数据包分为一组

4. 获取进程特征：根据端口号统计每个组内的进程数`Pi`

5. 获取数据包特征：根据包头信息计算出每个分组的包的总大小`Ti`，包数`Bi`， 并计算每个分组的包的平均大小`ti＝ Ti/Bi` 和进程的平均发包数`bi = Bi/Pi`

6. 进程特征检测：正常连接中主机间通信进程数`Pi`少且稳定，其数学期望`E(Pi)`近似为１；暴力破解行为存在的可能性和进程数成正比，可以根据进程数将通信分为2个等级：`１≤Pi＜５`时，不确定是否异常，需要做进一步检测；`Pi≥５`时为暴力破解攻击．通过如此分级可以过滤大量明显的攻击数据包，减少计算量，

7. 数据包特征检测：通过计算标准差判断数据波动大小

   <img src="C:\Users\贾元第\AppData\Roaming\Typora\typora-user-images\image-20240927164806261.png" alt="image-20240927164806261" style="zoom: 50%;" />

8. 根据进程特征检测和数据包特征的检测就可以识别出是否存在暴力破解行为

9. 总流程如下：

<img src="C:\Users\贾元第\AppData\Roaming\Typora\typora-user-images\image-20240927164947954.png" alt="image-20240927164947954" style="zoom:50%;" />

#### 4.1.4 优缺点

优点：

1. 可适用识别多种协议攻击
2. 识别准确率高

缺点：

1. 资源消耗大：占用大量带宽和计算资源
2. 实现复杂度高、实现周期长





### 4.2 基于机器学习的入侵检测

> 参考：[基于机器学习的入侵检测系统：原理、应用与实践-百度开发者中心 (baidu.com)](https://developer.baidu.com/article/details/3024884)
>
> [[当人工智能遇上安全\] 6.基于机器学习的入侵检测和攻击识别——以KDD CUP99数据集为例_以kdd cup99作为数据集实现入侵检测-CSDN博客](https://blog.csdn.net/Eastmount/article/details/120932747)
>
> [基于循环神经网络模型的用户入侵行为检测与管控研究 (hit.edu.cn)](https://cs.hit.edu.cn/_upload/article/files/23/e0/ae1b65fd490d9d2072decdb68167/1810590f-729b-41c1-8329-220dd2b42d46.pdf)

#### 4.2.1 技术原理

- 使用机器学习算法，可以基于历史SSH登录数据(登录时间段、Ip位置、设备指纹等)训练模型，识别潜在的异常行为
- 监督学习：通过训练有标注的数据（正常登录行为和攻击行为），机器学习模型可以自动检测和分类 SSH 登录事件，区分合法与非法的登录。
- 无监督学习：当没有明确的攻击标签时，可以使用聚类算法（如 k-means）来发现离群点（outlier detection）。异常的登录行为（如突然的登录时间、IP 位置或设备特征变化）会被标记为离群点。

#### 4.2.2 技术应用

1. **Splunk**提供了机器学习工具包：**Splunk Machine Learning Toolkit**，用户可以利用这些工具对SSH登录数据进行深度分析
2. **Github、Google**等社区分享其基于机器学习的入侵检测系统
3. 网络安全公司**Darktrace**使用了自适应免疫系统使用机器学习算法来监测网络活动，检测异常的 SSH 登录行为，并在发现潜在威胁时自动响应

#### 4.2.3 设计实现

1. 使用**ELK stack(Elasticsearch、Logstash 和 Kibana)**：使用 Logstash 收集 SSH 登录事件(分析网络流量、用户行为、设备活动)，存储在 Elasticsearch 中，并通过 Kibana 可视化。
2. 机器学习模块：用于创建模型，自动检测登录异常活动
3. 异常响应/警报：封禁ip等操作

#### 4.2.4 优缺点

优点：

1. 强大的检测能力：可以基于机器学习发现传统方法无法检测到的攻击模式
2. 可扩展性强
3. 随着时间和训练可以持续学习

缺点：

1. 训练的数据需求量大
2. 模型实现比较复杂度，需要专业的机器学习知识





## 5. 总结

当前主流的实现防暴力破解登录检测的技术有：基于日志分析、基于流量分析、基于流量特征分析、基于(用户行为)机器学习等技术；其中，基于日志分析和基于流量分析的策略是市面上主要防暴力破解软件的主要技术手段，基于流量特征和基于机器学习的策略以其准确度高、识别范围广、解决了前两种技术方式的不足等优点正成为未来主流的防暴力破解技术手段。

对于现存阶段的需求和时间紧迫性，为了实现防暴力破解功能，个人建议在前两种技术上做选择，以下是两种技术的优缺点比较：

|              |         基于日志分析         |  基于流量分析  |
| :----------: | :--------------------------: | :------------: |
|    时效性    | 一般(可通过缩短检测间隔补足) |       好       |
|    准确性    |             准确             | 一般(容易误判) |
| 占用系统资源 |              少              |       多       |
|   实现难度   |             简单             |      一般      |

从时效性、准确性、占用系统资源、实现难度等层面上比较，我会选择使用基于日志分析的技术手段来实现防暴力破解功能

